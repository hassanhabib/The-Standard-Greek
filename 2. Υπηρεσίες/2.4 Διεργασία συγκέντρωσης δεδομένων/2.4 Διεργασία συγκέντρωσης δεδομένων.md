# 2.4 Διεργασίες συσσώρευσης (The Knot)

## 2.4.0 Εισαγωγή

Η βασική ευθύνη μίας υπηρεσίας συσσώρευσης (aggregation service) είναι να παρέχει ένα μοναδικό σημείο επαφής μεταξύ του πυρήνα της επιχειρησιακής λογικής και οποιωνδήποτε επιπέδων εκθέσεων. Βεβαιώνει ότι πολλές υπηρεσίες οποιασδήποτε ποικιλίας μοιράζονται την ίδια σύμβαση για να συσσωρευτούν και να εκθέσουν σε ένα στοιχείο εκθέσεων μέσω μιας λογικής.

Οι υπηρεσίες συσσώρευσης δεν περιλαμβάνουν καμία επιχειρησιακή λογική από μόνες τους. Είναι απλώς ένας κόμπος που συνδέει μαζί πολλές υπηρεσίες οποιουδήποτε αριθμού. Μπορούν να έχουν ως εξαρτήσεις οποιοδήποτε επίπεδο υπηρεσιών και κυρίως εκθέτουν την κλήση προς αυτές τις υπηρεσίες αναλόγως. Παρακάτω υπάρχει ένα παράδειγμα κώδικα μιας υπηρεσίας συσσώρευσης:

```csharp
public async ValueTask ProcessStudentAsync(Student student)
{
    await this.studentRegistrationCoordinationService.RegisterStudentAsync(student);
    await this.studentRecordsCoordinationService.AddStudentRecordAsync(student);
    ...
    ...
    await this.anyOtherStudentRelatedCoordinationService.DoSomethingWithStudentAsync(student);    
}
```

Όπως φαίνεται στο απόσπασμα που παρατίθεται παραπάνω, μια υπηρεσία συσσώρευσης μπορεί να έχει οποιονδήποτε αριθμό κλήσεων σε οποιαδήποτε σειρά χωρίς περιορισμό. Και μπορεί να υπάρχουν περιπτώσεις όπου ενδέχεται να χρειάζεται ή να μη χρειάζεται να επιστρέψετε μια τιμή στα επίπεδα εκθέσεων σας, ανάλογα με την συνολική ροή και αρχιτεκτονική, την οποία θα συζητήσουμε σύντομα σε αυτό το κεφάλαιο. Ωστόσο, πιο σημαντικά, οι υπηρεσίες συσσώρευσης δεν πρέπει να συγχέονται με τις υπηρεσίες ενορχήστρωσης ή οποιαδήποτε από τις παραλλαγές τους.

## 2.4.1 Στον Χάρτη

Οι υπηρεσίες συσσώρευσης βρίσκονται πάντα στην άλλη άκρη ενός πυρήνα επιχειρησιακής λογικής. Είναι το τελευταίο σημείο επαφής μεταξύ των επιπέδων εκθέσεων και των επιπέδων λογικής. Παρακάτω υπάρχει μια απεικόνιση της θέσης των υπηρεσιών συσσώρευσης σε μια συνολική αρχιτεκτονική:

<br />
    <p align="center" >
        <img src="https://user-images.githubusercontent.com/1453985/147583126-c2b73db9-f77f-486f-806a-e9bfe32cec16.png" />
    </p>
<br />

Ας συζητήσουμε τα χαρακτηριστικά των υπηρεσιών συσσώρευσης.

## 2.4.2 Χαρακτηριστικά

Οι υπηρεσίες συσσώρευσης υπάρχουν κυρίως όταν πολλές υπηρεσίες μοιράζονται την ίδια σύμβαση ή πρωτεύοντα τύποι της ίδιας σύμβασης, απαιτώντας ένα μοναδικό σημείο εκθέσεων. Υπάρχουν κυρίως σε υπερπολύπλοκες εφαρμογές όπου πολλές υπηρεσίες (συνήθως ορχήστρωσης ή ακόμη και υψηλότερου επιπέδου) απαιτούν ένα μόνο σημείο επαφής μέσω των επιπέδων εκθέσεων. Ας μιλήσουμε αναλυτικά για τα βασικά χαρακτηριστικά των υπηρεσιών συσσώρευσης.

### 2.4.2.0 Χωρίς Περιορισμό στις Εξαρτήσεις (No Dependency Limitation)

Σε αντίθεση με οποιαδήποτε άλλη υπηρεσία, οι υπηρεσίες συσσώρευσης μπορούν να έχουν οποιονδήποτε αριθμό εξαρτήσεων, όσο αυτές οι υπηρεσίες είναι της ίδιας ποικιλίας. Για παράδειγμα, μια υπηρεσία συσσώρευσης δεν μπορεί να συσσωρεύει ανάμεσα σε μια υπηρεσία ορχήστρωσης και μια υπηρεσία συντονισμού. Είναι ένα μοτίβο τύπου Florance, όπου οι υπηρεσίες πρέπει να είναι της ίδιας ποικιλίας, αλλά όχι απαραιτήτως περιορισμένες από τον αριθμό.

Ο απουσιάζον περιορισμός των εξαρτήσεων για τις υπηρεσίες συσσώρευσης οφείλεται στο ότι η υπηρεσία δεν πραγματοποιεί καμία επίπεδο επιχειρηματικής λογικής ανάμεσα σε αυτές τις υπηρεσίες. Δεν ενδιαφέρεται για το τι κάνουν ή απαιτούν αυτές οι υπηρεσίες. Επικεντρώνεται μόνο στο να εκθέτει αυτές τις υπηρεσίες, ανεξαρτήτως του τι καλείται πριν ή μετά από αυτές.

Παρακάτω εμφανίζεται πώς θα μπορούσε να είναι ένα τεστ για μια υπηρεσία συσσώρευσης:

```csharp

[Fact]
public async Task ShouldProcessStudentAsync()
{
    // given
    Student randomStudent = CreatedRandomStudent();
    Student inputStudent = randomStudent;

    // when
    await this.studentAggregationService.ProcessStudentAsync(inputStudent);

    // then
    this.studentRegistrationCoordinationServiceMock.Verify(service =>
        service.RegisterStudentAsync(student),
            Times.Once);

    this.studentRecordsCoordinationServiceMock.Verify(service =>
        service.AddStudentRecordAsync(student),
            Times.Once);
    ...
    ...

    this.anyOtherStudentRelatedCoordinationServiceMock.Verify(service =>
        service.DoSomethingWithStudentAsync(student),
            Times.Once);

    this.studentRegistrationCoordinationServiceMock.VerifyNoOtherCalls();
    this.studentRecordsCoordinationServiceMock.VerifyNoOtherCalls();
    ...
    ...
    this.anyOtherStudentRelatedCoordinationServiceMock.VerifyNoOtherCalls();
}
```

Όπως μπορείτε να δείτε παραπάνω, επαληθεύουμε και δοκιμάζουμε μόνο την πτυχή της συσσώρευσης καλώντας αυτές τις υπηρεσίες. Δεν απαιτείται τύπος επιστροφής σε αυτήν την περίπτωση, αλλά μπορεί να απαιτηθεί στις περιπτώσεις της διέλευσης, τις οποίες θα συζητήσουμε σύντομα.

Μια υλοποίηση του παραπάνω τεστ θα μπορούσε να είναι ως εξής:

```csharp
public async ValueTask ProcessStudentAsync(Student student)
{
    await this.studentRegistrationCoordinationService.RegisterStudentAsync(student);
    await this.studentRecordsCoordinationService.AddStudentRecordAsync(student);
    ...
    ...
    await this.anyOtherStudentRelatedCoordinationService.DoSomethingWithStudentAsync(student);    
}
```

### 2.4.2.1 No Order Validation

Με βάση τον ορισμό, οι υπηρεσίες συσσώρευσης απαιτείται φυσικά να καλούν πολλαπλές εξαρτήσεις χωρίς περιορισμό. Η σειρά κλήσης αυτών των εξαρτήσεων δεν αποτελεί επίσης ανησυχία ή ευθύνη για τις υπηρεσίες συσσώρευσης, διότι η επαλήθευση της σειράς κλήσης θεωρείται επιχειρησιακή λογική πυρήνα, η οποία εμπίπτει στις ευθύνες μιας υπηρεσίας συσσώρευσης. Αυτό περιλαμβάνει τόσο τη φυσική σειρά επαλήθευσης όσο και την υποχρεωτική σειρά επαλήθευσης, όπως εξηγήσαμε στην ενότητα 2.3.3.0.1 στο προηγούμενο κεφάλαιο.

Είναι παραβίαση του Προτύπου να χρησιμοποιηθούν απλές τεχνικές όπως μια σειρά εκδοχής για να δοκιμαστεί μια υπηρεσία συσσώρευσης. Είναι επίσης παραβίαση να επαληθευθεί η εξάρτηση από την τιμή επιστροφής μιας κλήσης υπηρεσίας για να εκκινήσει μια κλήση στην επόμενη. Αυτές οι ευθύνες είναι πιο πιθανό να εκτελεστούν στο επόμενο χαμηλότερο επίπεδο μιας υπηρεσίας συσσώρευσης για οποιαδήποτε υπηρεσία παρόμοια με ορχήστρωση.

### 2.4.2.2 Βασικές Επαληθεύσεις

Οι υπηρεσίες συσσώρευσης πρέπει ακόμη να επαληθεύουν εάν τα εισερχόμενα δεδομένα είναι δομικά έγκυρα σε υψηλότερο επίπεδο. Για παράδειγμα, μια υπηρεσία συσσώρευσης που δέχεται ένα αντικείμενο `Student` ως παράμετρο εισόδου θα επαληθεύει μόνο εάν το `student` είναι `null` ή όχι. Αλλά εκεί σταματά όλο αυτό.

Μπορεί να υπάρξει μια περίπτωση όπου μια εξάρτηση απαιτεί να περάσει μια ιδιότητα ενός παραμέτρου εισόδου, στην οποία περίπτωση επιτρέπεται επίσης να επαληθεύσει τη δομή της τιμής της ιδιότητας. Για παράδειγμα, αν μια εξάρτηση κάτω ρεύματος απαιτεί να περαστεί το όνομα ενός φοιτητή. Μια υπηρεσία συσσώρευσης θα πρέπει ακόμη να επαληθεύει εάν το `Name` είναι `null`, κενό ή απλώς κενά διαστήματα.

### 2.4.2.3 Διέλευση (Pass-Through)

Οι υπηρεσίες συσσώρευσης δεν απαιτείται να υλοποιούν τη συσσώρευσή τους εκτελώντας πολλαπλές κλήσεις από μια μέθοδο. Μπορούν επίσης να συσσωρεύουν παρέχοντας μεθόδους διέλευσης για πολλές υπηρεσίες. Για παράδειγμα, υποθέστε ότι έχουμε τις υπηρεσίες `studentCoordinationService`, `studentRecordsService` και `anyOtherStudentRelatedCoordinationService`, όπου κάθε υπηρεσία είναι ανεξάρτητη από πλευράς ροής επιχειρήσεων. Έτσι, η συσσώρευση εδώ είναι μόνο στο επίπεδο της έκθεσης και όχι απαραιτήτως στο επίπεδο της εκτέλεσης.

Εδώ υπάρχει ένα παράδειγμα κώδικα:

```csharp
public partial class StudentAggregationService
{
    ...

    public async ValueTask<Student> RegisterStudentAsync(Student student)
    {
        ...

        return await this.studentCoordinationService.RegisterStudentAsync(student);
    }

    public async ValueTask<Student> AddStudentRecordAsync(Student student)
    {
        ...

        return await this.studentRecordsCoordinationService.AddStudentRecordAsync(student);
    }

    ...
    ...

    public async ValueTask<Student> DoSomethingWithStudentAsync(Student student)
    {
        ...

        return await this.anyOtherStudentRelatedCoordinationService.DoSomethingWithStudentAsync(student);
    }
}
```

Όπως βλέπετε παραπάνω, κάθε υπηρεσία χρησιμοποιεί την υπηρεσία συσσώρευσης ως διέλευση. Δεν υπάρχει καμία ανάγκη σε αυτό το σενάριο για κλήση συσσωρευμένων διαδικασιών. Αυτό θα ήταν ακόμη ένα πολύ έγκυρο σενάριο για τις υπηρεσίες συσσώρευσης.

### 2.4.2.4 Προαιρετικότητα

Είναι σημαντικό να αναφέρουμε εδώ ότι οι υπηρεσίες συσσώρευσης είναι προαιρετικές. Αντίθετα με τις υπηρεσίες βάσης, οι υπηρεσίες συσσώρευσης μπορεί να υπάρχουν ή να μην υπάρχουν στην αρχιτεκτονική. Οι υπηρεσίες συσσώρευσης υπάρχουν για να επιλύσουν ένα πρόβλημα με την αφαίρεση. Αυτό το πρόβλημα μπορεί να υπάρχει ή να μην υπάρχει ανάλογα με το αν η αρχιτεκτονική απαιτεί ένα μόνο σημείο έκθεσης στο όριο του πυρήνα του επιχειρηματικού λογικού ή όχι. Αυτή η μοναδική ευθύνη των υπηρεσιών συσσώρευσης καθιστά πολύ πιο απλή την υλοποίηση της εργασίας της και την εκτέλεση της λειτουργίας της με ευκολία. Η προαιρετικότητα των υπηρεσιών συσσώρευσης είναι πολύ πιο πιθανή από άλλες υπηρεσίες σε χαμηλότερο επίπεδο. Ακόμη και στις πιο πολύπλοκες εφαρμογές.

### 2.4.2.5 Επίπεδο Ρουτίνας Συσσώρευσης

Εάν μια υπηρεσία συσσώρευσης πρέπει να πραγματοποιήσει δύο διαφορετικές κλήσεις από την ίδια εξάρτηση ανάμεσα σε άλλες κλήσεις, συνιστάται να συσσωρεύει για κάθε ρουτίνα εξάρτησης. Αλλά αυτό είναι μόνο από την οπτική γωνία του καθαρού κώδικα και δεν επηρεάζει απαραίτητα την αρχιτεκτονική ή το τελικό αποτέλεσμα.

Εδώ υπάρχει ένα παράδειγμα:

```csharp
public async ValueTask ProcessStudent(Student student)
{
    await this.studentCoordinationService.AddStudentAsync(student);
    await ProcessStudentRecordAsync(student);
}

private async ValueTask ProcessStudentRecordAsync(Student student)
{
    await this.studentRecordCoordinationService.AddStudentRecordAsync(student);
    await this.studentRecordCoordinationService.NotifyStudentRecordAdminsAsync(student);
}

```

Αυτή η οργανωτική ενέργεια δεν δικαιολογεί καμία αλλαγή στον έλεγχο ή στο τελικό αποτέλεσμα, όπως αναφέρθηκε προηγουμένως.

### 2.4.2.6 Καθαρές Συμβάσεις Εξάρτησης
Ο πιο σημαντικός κανόνας/χαρακτηριστικό μιας υπηρεσίας συσσώρευσης είναι ότι οι εξαρτήσεις της (αντίθετα από τις υπηρεσίες οργάνωσης) πρέπει να μοιράζονται την ίδια σύμβαση. Η παράμετρος εισόδου για μια δημόσια διαδικασία σε οποιαδήποτε υπηρεσία συσσώρευσης πρέπει να είναι η ίδια για όλες τις εξαρτήσεις της. Μπορεί να υπάρχουν περιπτώσεις όπου μια εξάρτηση μπορεί να απαιτεί ένα αναγνωριστικό φοιτητή αντί για ολόκληρο τον φοιτητή, το οποίο επιτρέπεται με προσοχή, εφόσον η μερική σύμβαση δεν είναι τύπος επιστροφής μιας άλλης κλήσης εντός της ίδιας διαδικασίας.

## 2.4.3 Ευθύνες (Responsibilities)
Ο βασικός ρόλος μιας υπηρεσίας συσσώρευσης είναι να προσφέρει ένα μόνο σημείο επαφής μεταξύ των στοιχείων έκθεσης και του υπόλοιπου πυρήνα της επιχειρηματικής λογικής. Αλλά στην ουσία, η αφαίρεση είναι η πραγματική αξία που προσφέρουν οι υπηρεσίες συσσώρευσης για να εξασφαλίσουν ότι οποιοδήποτε επιχειρηματικό στοιχείο μπορεί να ενσωματωθεί σε οποιοδήποτε σύστημα ανεξάρτητα από το στυλ έκθεσης.

Ας μιλήσουμε για αυτές τις ευθύνες λεπτομερώς.

### 2.4.3.0 Abstraction
Μια υπηρεσία συσσώρευσης εκτελεί τις ευθύνες της με επιτυχία όταν οι πελάτες ή οι καταναλωτές της δεν έχουν καμία ιδέα για το τι βρίσκεται πέρα από τις γραμμές της υλοποίησής της. Μια υπηρεσία συσσώρευσης μπορεί να συνδυάσει δέκα διαφορετικές υπηρεσίες και να εκθέσει μια μόνο διαδικασία σε ένα σενάριο "fire-n-forget" (αναφορά και λήψη του επόμενου βήματος χωρίς περαιτέρω αναμονή).

Αλλά ακόμη και σε περιπτώσεις διέλευσης, οι υπηρεσίες συσσώρευσης αφαιρούν κάθε αναγνώριση της υποκείμενης εξάρτησης από τους έκθετες υποχρεωτικά. Δεν συμβαίνει πάντα, ειδικά όσον αφορά τοπικά abstractions, αλλά είναι αρκετά κοντά ώστε να κάνει την ολοκλήρωση να φαίνεται ως να γίνεται με μια μόνο υπηρεσία που προσφέρει όλες τις επιλογές φυσικά.

### 2.4.3.1 Exceptions Aggregation
Οι υπηρεσίες συσσώρευσης είναι παρόμοιες με τις υπηρεσίες ορχήστρωσης όσον αφορά την αντιστοίχιση και τη συσσώρευση των εξαιρέσεων από τις εξαρτήσεις κάτω από το σημείο επαφής. Για παράδειγμα, εάν η `studentCoordinationService` εκτοξεύει μια `StudentCoordinationValidationException`, μια υπηρεσία συσσώρευσης θα αντιστοιχίσει αυτήν σε `StudentAggregationDependencyValidationException`. Αυτό επιστρέφει στον έννοια της αποσυσκευασίας των εξαιρέσεων και στη συνέχεια της συσκευασίας των τοπικών εξαιρέσεων, το οποίο συζητήσαμε αναλυτικά στην ενότητα 2.3.3.0.2 αυτού του πρότυπου.
